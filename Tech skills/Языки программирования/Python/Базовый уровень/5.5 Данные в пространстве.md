## Сети

Распределенные вычисления и сети решают следующие задачи
- Производительность - быстрые компоненты должны оставаться занятыми и не ждать пока отработают медленные.
- Устойчивость - нужно дублировать задачи чтобы обойти проблемы по отказу аппаратного и ПО.
- Простота - разбитие сложных задач на множество простых, которые легче создавать, понимать и исправлять.
- Масштабируемость - увеличение количества серверов, чтобы справляться с нагрузкой и уменьшение их для экономии денег.

### TCP/IP
Соединения, обмен, обработка данных в интернете основаны на соглашениях. Такие правила называются протоколами и они упорядочены в слои.

Можно делать что угодно в рамках одного слоя, пока мы следуем соглашениям, связанными с работой с более низкими и высокими слоями.

Самый нижний слой управляет такими аспектами, как электрические сигналы. Каждый более высокий слой базируется на нижних. Примерно в середине находится IP (Internet Protocol — интернет-протокол), на котором определяется, как  адресуются локации сети и перемещаются пакеты (фрагменты) данных. На слое, расположенном выше IP, два протокола описывают, как перемещать байты между локациями.

UDP (User Datagram Protocol — протокол датаграмм пользователя). Служит для обмена небольшим объемом данных. Датаграмма — это небольшое сообщение, которое отправляется целиком; оно похоже на открытку.

TCP (Transmission Control Protocol — протокол управления передачей). Используется для более длинных соединений. С его помощью отправляются потоки байтов, он гарантирует, что они придут по порядку и без дупликаций.

Локальная машина всегда будет иметь IP-адрес 127.0.0.1 и имя localhost. Можно встретить название для этого процесса — интерфейс обратной петли. При подключении к Интернету также появится публичный IP. Если используется домашний компьютер, то он будет скрыт за оборудованием, таким как кабельный модем или роутер. Можно запускать интернет-протоколы даже между процессами на одной машине.

Большая часть Интернета, с которой нужно взаимодействовать, — Всемирная паутина, серверы баз данных и т.д. основана на протоколе TCP, функционирующем поверх протокола IP, сокращенно — TCP/IP.

### Паттерны для работы с сетями
Сетевые приложения можно создать на основе некоторых простых паттернов.

Самым распространенным является «Запрос — ответ», также известный как «Клиент — сервер». Работает синхронно: клиент ожидает ответа сервера. Браузер — это также клиент, делающий HTTP-запрос веб-серверу, который возвращает ответ. Пример - запрос данных о DNS, сети или электронной почте у серверов. Они возвращают ответ или сообщают о проблеме. Для работы можно использовать библиотеку ZeroMQ, называемую сокетами на стероидах.

Еще один распространенный паттерн — «Разветвление на выходе»: вы отправляете данные любому доступному работнику из пула процессов. Примером служит веб-сервер, расположенный за балансировщиком нагрузки.

Противоположностью этого паттерна является «Разветвление на входе»: вы  принимаете данные из одного или нескольких источников. В качестве примера можно привести регистратор, который принимает текстовые сообщения от нескольких процессов и записывает их в единый файл журнала.

Еще один паттерн похож на радио- или телепередачи, он называется «Публикация — подписка» или pub — sub. В рамках этого паттерна публикатор рассылает данные. В простой системе их получат все подписчики. Однако зачастую они могут указать, что заинтересованы только в определенных типах данных (подобные типы часто называются темами), и публикатор будет отправлять лишь эту информацию. Поэтому, в отличие от паттерна «Разветвление на входе», заданный фрагмент данных может получить более чем один подписчик. Если на тему никто не подписался, то данные будут проигнорированы.


Сериализация - преобразование между данными в памяти и последовательностями байтом, в частности, перед их отправкой другому клиенту.

JSON - популярный формат сериализации в RESTful-системах, но с его помощью нельзя выразить все типы данныех Питона.

Pickle - модуль для сохранения и восстановления любого объекта в специальном бинарном формате.

Удаленные вызовы процедур (Remote Procedure Call, RPC) выглядят как обычные функции, но выполняются на удаленных машинах по всей сети. Вместо того чтобы вызывать RESTful API и передавать туда аргументы, закодированные в URL или теле запросов, вы можете вызвать функцию RPC на собственной машине. При этом в RPC-клиенте произойдет следующее.
- преобразует аргументы функции в байты
- отправляет закодированные байты удаленной машине.

На удаленной машине
- полумает закодированные байты запроса
- после получения байто RPC-клиент декодирует их в оригинальные структуры данных
- затем клиент находит и вызывает локальную функцию с помощью раскодированных данных
- далее он кодирует результат работы функции
- отправляет закодированные байты вызывающей стороне.

Затем машина, запустившая процесс, декодирует полученные байты в возвращенные значения.
RPC — это популярный прием, и люди реализовали его множеством способов. На стороне сервера вы запускаете серверную программу, создаете механизм для ее связывания с помощью какого-либо способа транспортировки байтов и метода кодирования/декодирования, определяете функции сервиса и подаете сигнал «RPC готов к работе». Клиенты соединяются с сервером и вызывают одну из его функций с помощью RPC.

Есть XML RPC, JSON RPC, MessagePack RPC, Zerorpc, gRPC, Twirp. 

Инструменты удаленного управления - Salt, Puppet, Chef, Ansible.

### Работа с большими потоками данных

MapReduce - распределяет вычисления между несколькими ПК и затем собирает результат.

Hfdoop - пакет с открытым исходным кодом для работы с большими данными. Пакет копирует данные среди машин, пропускает их через программы масштабирования и сжатия и сохраняет на диск результаты после каждого шага. Этот процесс может быть медленным, более быстрый метод - отправка потоком с помощью Hadoop. Он посылает данные между программами и не требует записи на диск после выполнения каждого этапа.

Spark - аналог Hadoop и работает быстрее. Disco, Dask - аналоги.


### Работа в облаках
Примеры - Amazon AWS (boto3 - библиотека для Python), Google, Microsoft Azure. 

OpenStack - бесплатное решение с открытым кодом.

Docker - контейнеры, они легче чем виртуальные машины, позволяют упаковать приложение отдельно от других программ на одной и той же машине. 

Kubernetes - управление большим количеством контейнеров и автоматизация операций. Выполняет обход отказов, балансировку нагрузки, масштабирование.

### Интернет
В 1989 году английский ученый Тим Бернерс-Ли впервые внес предложение помочь распространять информацию внутри CERN, а также среди всего исследовательского сообщества. Он назвал его World Wide Web (Всемирная паутина) и довольно быстро выделил три основные идеи, которые должны были лечь в основу ее дизайна:
- HTTP (Hypertext Transfer Protocol — протокол передачи гипертекста) — протокол для веб-клиентов и серверов для обмена запросами и ответами;
- HTML (Hypertext Markup.Language — гипертекстовый язык разметки) — формат для представления результатов;
- URL (Uniform Resource Locator — единообразный локатор ресурса) — способ уникально обозначить сервер и ресурс на этом сервере.
В самом простом варианте использования веб-клиент соединяется с веб-сервером с помощью протокола HTTP, запрашивает URL и получает HTML.
Все это было создано на базе сети Интернет, который в то время был некоммерческим, им пользовались лишь несколько университетов и исследовательских организаций.
Бернерс-Ли написал первый браузер и сервер на компьютере NeXT. Известность Всемирной паутины значительно возросла в 1993-м, когда группа студентов Иллинойсского университета выпустила браузер Mosaic и сервер NCSA httpd.

Практически каждый язык программирования был использован для написания веб-клиентов и веб-серверов. Динамические языки Perl, PHP и Ruby стали особенно популярными. Python особенно хорош для работы в Интернете на любом из таких уровней, как:
- клиенты для удаленного доступа;
- серверы, предоставляющие данные для сайтов и веб-API;
- веб-API и сервисы, позволяющие обмениваться данными другими способами, отличающимися от просматриваемых веб-страниц

### Веб-клиенты
Низкоуровневая система проводящих путей Интернета называется Transmission Control Protocol/Internet Protocol (протокол управления передачей/интернет протокол). Он перемещает байты между ПК, но не обращает внимания на то, что они значат.

HTTP - стандартный протокол для обмена данными сети. Является высокоуровневым протоколом.

Всемирная паутина — это клиент-серверная система. Клиент делает запрос серверу: он открывает соединение TCP/IP, отправляет URL и другую информацию с помощью HTTP и получает ответ.
Формат ответа также определяется протоколом HTTP. Он включает в себя статус запроса и (в том случае, если запрос выполнен успешно) данные и формат ответа.
Самый известный веб-клиент — это браузер. Он может создавать HTTP-запросы несколькими способами. Можно инициировать запрос вручную, написав URL в адресной строке или нажав ссылку на веб-странице.
 
Важный аспект HTTP — этот протокол не имеет состояния. Каждое создаваемое вами соединение HTTP не зависит от других. Это упрощает базовые операции, но усложняет другие .Рассмотрим несколько примеров таких усложнений.
- Кэширование. Удаленный контент, который не меняется, должен быть сохранен веб-клиентом и использован для того, чтобы не загружать его с сервера снова.
- Сессии. Интернет-магазин должен запоминать содержимое корзины.
- Аутентификация. Сайты, которые требуют ваши имя пользователя и пароль, должны запоминать их, пока вы авторизованы.
 
Решения для описанных усложнений включают в себя cookie, в которых сервер отправляет клиенту довольно специфическую информацию, позволяющую их распознать, когда клиент отправляет эти файлы назад.

Стандартные веб-библиотеки Питона - http (client, server, cookies, cookiejar) и urllib (request, response, perse). Сторонняя бибилиотека - requests.

### Веб-серверы
Представлены в основном в виде фреймворков. 

Простейший веб-сервер запускается командой `python -m http.server 9999`

WSGI - универсальное API между веб-приложениями и веб-серверами. Его используют в основном все веб-фреймворки и веб-серверы на Python. WSGI (Web Server Gateway Interface) использует синхронное соединение.

ASGI (Asynchronous Server Gateway Interface) - аналог WSGI, который использует асинхроннные возможности языка, такие как async, await, asyncio.

Apache - лучший WSGI-модуль apache это mod_wsgi.

NGINX - не имеет встроенного модуля Python. Он обменивается данными с помощью отдельного сервера WSGI, такого как uWSGI или gUnicorn.

Веб-фреймворки решают такие задачи:
- обработка протокола HTTP;
- аутентификация (authn, или «кто ты?»);
- авторизация (authz, или «что ты можешь сделать?»);
- создание сессии;
- получение параметров;
- валидация параметров (обязательные/опциональные, тип, диапазон);
- обработка глаголов HTTP;
- маршрутизация (функции/классы)
- выдача статических файлов (HTML, JS, CSS, изображения);
- выдача динамических данных (базы данных, сервисы);
- возврат значений и статусов HTTP.
Опциональные возможности:
- создание шаблонов для бэкенда;
- соединение с базами данных, ORM;
- ограничение скорости;
- асинхронные задачи.

REST API. API - Application Programming Interface, по которому клиенту получают доступ к сайту в удобном формате, например, JSON. REST - Representational State Transfer, передача состояния представления. Многие продукты имеют REST-интерфейс или интерфейс RESTful. На практике это часто означает, что они имеют веб-интерфейс — определения URL, предназначенные для доступа к веб-сервису.

Сервис RESTful использует глаголы HTTP определенными способами, описанными далее:
- HEAD получает информацию о ресурсе, но не его данные;
- GET получает данные ресурса с сервера. Это стандартный метод, используемый браузером. GET не должен применяться для создания, изменения или удаления данных;
- POST создает новый ресурс;
- PUT заменяет существующий ресурс, создавая его, если его нет;
- PATCH частично обновляет ресурс;
- DELETE — удаляет.
 
Клиент RESTful также может запрашивать содержимое одного или нескольких типов с помощью заголовков запроса HTTP. Например, сложный сервис с интерфейсом REST может принимать и возвращать данные в строках JSON.

424
