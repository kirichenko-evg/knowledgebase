## QuerySet API
В терминале запускаем консоль `./manage.py shell`.

- Импортируем класс `from products.models import Product`
- Product.objects.filter(id=1) - вернет QuerySet (список)
- Product.objects.all() - вернет QuerySet, все объекты
- Product.objects.get(id=1) - вернет сам продукт, не QuerySet
- create() - также возвращает определенный объект

Возврат QuerySet
- Product.objects.all().order_by('name') - выведет в алфавитном порядке по имени
- Product.objects.all().order_by('-name') - выведет в обратном алфавитном порядке по имени
- Product.objects.order_by('name') - можно применять напрямую к objects

Возврат значений
- Product.objects.count() - сколько объектов в БД
- Product.objects.filter(id=1).exists() - вернет True, если список не пустой

- Product.objects.filter(name__startswith'Ч') - начинаются с буквы Ч
- Product.objects.filter(name__endswith'я') - заканчивается на я
- Product.objects.filter(price__gt=5000) - цена больше 5000
- Product.objects.filter(price__lt=5000) - цена меньше 5000
- `ids = [1, 3, 5]` Product.objects.filter(id__in=ids) - все объекты по определенным id

## Корзина товаров
Заходим в products `models.py` и создаем модель для корзины
```python
...
from users.models import User
...
class Basket(models.Model):
    user = models.ForeignKey(to=User, on_delete=models.CASCADE)
    product = models.ForeignKey(to=Product, on_delete=models.CASCADE)
    quantity = models.PositiveSmallIntegerField(default=0)
    created_timestamp = models.DateTimeField(auto_now_add=True)  # заполнится автоматом при создании объекта

    def __str__(self):
        return f'Корзина для {self.user.username} | Продукт: {self.product.name}'
```
Далее делаем миграции.

Корзина используется в существующем файле profile.html. View для него отдельно создавать не нужно. Нужно использовать включенные шаблоны. В products, templates создаем `baskets.html` и переносим в него кусок кода, который отвечаем за корзину. Это нужно для того, чтобы отдельно поработать с функционалом корзины.

В profile.html включаем шаблон baskets.html
```html
<div class="col-lg-5">
  {% include 'products/baskets.html' %}
</div>
```
Т.к. `baskets.html` - это часть `profile.html`, то в контроллере profile создаем ключ basket.

Для этого во `views.py` импортируем модель и создаем ключ 
```python
...
from products.models import Basket
...
def profile(request):
    ...
    context = {
        'title': 'Store - Профиль',
        'form': form,
        'baskets': Basket.objects.filter(user=request.user),  # показываем пользователю только его товары, т.к. корзина одна
    }
...
```
Как товар уходит в корзину? В каталоге есть кнопка Отправить в корзину. После ее нажатия товар должен уйти в корзину. Это реализуется при помощи контроллеров обработчиков событий. Импортируем Basket и User, а также HttpResponseRedirect и пишем обработчик

Идем в `products\views.py` 
```python
from django.shortcuts import render, HttpResponseRedirect
from products.models import ProductCategory, Product, Basket
from users.models import User
...
def basket_add(request, product_id):
    product = Product.objects.get(id=product_id)  # выбираем id объекта, который кладем в корзину
    baskets = Basket.objects.filter(user=request.user, product=product)

    if not baskets.exists():  # если товара нет в корзине
        Basket.objects.create(user=request.user, product=product, quantity=1)
    else:
        basket = baskets.first()  # т.к. товар единственный в корзине, его выбираем выше через filter
        basket.quantity += 1  # если товар присутствует, увеличим его на 1
        basket.save()

    # остаемся на странице с которой сделан запрос. Это может быть каталог или сама корзина
    return HttpResponseRedirect(request.META['HTTP_REFERER'])
```
В `products\urls.py` импортируем `basket_add и прописываем путь
```python
from products.views import products, basket_add
...
    #  передаем переменную из контроллера,
    #  указываем какого она типа и название из контроллера, название должно совпадать
    path('baskets/add/<int:product_id>/', basket_add, name='basket_add'),
```
Подключаем урл адрес в products.html. Меняем код кнопки Отправить корзину на ссылку. В href нужно не забыть прописать переменную product.id
```html
<div class="card-footer text-center">
    <a href="{% url 'products:basket_add' product.id %}" class="btn btn-outline-success">Отправить в корзину</a>
</div>
```
Делаем отображение карточек товара в `baskets.html` и вносим имя, описание и изменение цены.
```html
{% for basket in baskets %}
...
<h5 class="card-title">{{ basket.product.name }}</h5>
<p class="card-text">{{ basket.product.description }}</p>
...
<input name="basketID" type="number" class="form-control"
    value="{{ basket.quantity }}" min="0">
...                       
{% endfor %}
```
Делаем удаление товаров из корзины. В `products\views.py` создаем контроллер
```python
def basket_remove(request, basket_id):
    basket = Basket.objects.get(id=basket_id)
    basket.delete()
    return HttpResponseRedirect(request.META['HTTP_REFERER'])
```
В `products\urls.py` создаем url
```python
from products.views import products, basket_add, basket_remove
...
path('baskets/remove/<int:basket_id>/', basket_remove, name='basket_remove'),
```
И в `baskets.html` прописывается нужны url `<a href="{% url 'products:basket_remove' basket.id %}">`

##  Методы корзины
Используемые методы - sum(), total_quantity, total_sum(). 

Переходим в `products\models.py` и создаем метод sum() в классе `Basket`.
```python
    def sum(self):
        return self.product.price * self.quantity
```
И в `baskets.html` меняем значение для суммы ` <div class="col-lg-4">{{ basket.sum }}</div>`

Идем в `users\views.py` и вносим правки.

